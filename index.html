<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Deep Looking</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #1a1a2e;
    color: #e0e0e0;
    font-family: 'Georgia', serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    padding: 20px;
  }
  h1 {
    font-size: 1.6rem;
    font-weight: 300;
    letter-spacing: 0.15em;
    margin-bottom: 8px;
    color: #c4a35a;
  }
  .subtitle {
    font-size: 0.9rem;
    color: #888;
    margin-bottom: 20px;
  }
  .viewer {
    position: relative;
    display: inline-block;
    cursor: crosshair;
  }
  .viewer img {
    display: block;
    max-width: 95vw;
    max-height: 80vh;
  }
  .popup {
    position: fixed;
    background: rgba(26, 26, 46, 0.97);
    border: 1px solid #c4a35a;
    border-radius: 10px;
    padding: 16px;
    color: #e0e0e0;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s;
    z-index: 100;
    width: 320px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.6);
  }
  .popup.visible { opacity: 1; }
  .popup.pinned { pointer-events: auto; }
  .popup-close {
    position: absolute;
    top: 8px;
    right: 12px;
    font-size: 1.3rem;
    color: #999;
    cursor: pointer;
    display: none;
    line-height: 1;
  }
  .popup-close:hover { color: #fff; }
  .popup.pinned .popup-close { display: block; }
  .popup .poem-title a {
    color: #c4a35a;
    text-decoration: none;
  }
  .popup .poem-title a:hover {
    text-decoration: underline;
  }
  .popup .lens-tabs {
    display: flex;
    gap: 0;
    margin-bottom: 10px;
    border-bottom: 1px solid rgba(196,163,90,0.3);
  }
  .popup .lens-tab {
    padding: 5px 12px;
    font-size: 0.75rem;
    font-family: 'Georgia', serif;
    color: #888;
    cursor: pointer;
    border: 1px solid transparent;
    border-bottom: none;
    border-radius: 6px 6px 0 0;
    background: none;
    transition: color 0.2s, background 0.2s;
    text-transform: capitalize;
  }
  .popup .lens-tab:hover {
    color: #c4a35a;
  }
  .popup .lens-tab.active {
    color: #c4a35a;
    background: rgba(196,163,90,0.1);
    border-color: rgba(196,163,90,0.3);
  }
  .popup .poem-title {
    font-size: 1rem;
    font-weight: 600;
    color: #c4a35a;
    margin-bottom: 2px;
  }
  .popup .poem-poet {
    font-size: 0.8rem;
    color: #999;
    margin-bottom: 10px;
    font-style: italic;
  }
  .popup .poem-image {
    width: 100%;
    border-radius: 6px;
    margin-bottom: 10px;
  }
  .popup .poem-text {
    font-size: 0.85rem;
    line-height: 1.5;
    color: #d0d0d0;
    white-space: pre-line;
  }
  /* Gallery styles */
  .gallery {
    max-width: 900px;
    width: 100%;
  }
  .gallery-grid {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 24px;
    margin-top: 20px;
  }
  .gallery-item {
    cursor: pointer;
    border-radius: 10px;
    overflow: hidden;
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(196,163,90,0.2);
    transition: transform 0.2s, border-color 0.2s;
    width: 280px;
  }
  .gallery-item:hover {
    transform: translateY(-4px);
    border-color: #c4a35a;
  }
  .gallery-item img {
    width: 100%;
    display: block;
  }
  .gallery-item .item-title {
    padding: 12px 12px 4px;
    font-size: 0.95rem;
    color: #c4a35a;
    text-align: center;
    letter-spacing: 0.05em;
  }
  .gallery-item .item-gallery {
    padding: 0 12px 12px;
    font-size: 0.8rem;
    text-align: center;
  }
  .gallery-item .item-gallery a {
    color: #888;
    text-decoration: none;
  }
  .gallery-item .item-gallery a:hover {
    color: #c4a35a;
    text-decoration: underline;
  }
  .back-btn {
    align-self: flex-start;
    background: none;
    border: 1px solid #c4a35a;
    color: #c4a35a;
    padding: 6px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-family: 'Georgia', serif;
    font-size: 0.85rem;
    margin-bottom: 12px;
    transition: background 0.2s;
  }
  .back-btn:hover {
    background: rgba(196,163,90,0.15);
  }
  .hidden { display: none; }
  .credits {
    margin-top: 16px;
    font-size: 0.75rem;
    color: #555;
  }
</style>
</head>
<body>

<h1>DEEP LOOKING</h1>

<!-- Gallery Screen -->
<div id="gallery-screen" class="gallery">
  <p class="subtitle" style="text-align:center">Select an artwork to explore</p>
  <div class="gallery-grid" id="gallery-grid"></div>
</div>

<!-- Viewer Screen -->
<div id="viewer-screen" class="hidden">
  <button class="back-btn" id="back-btn">&#8592; Back to Gallery</button>
  <p class="subtitle" id="viewer-subtitle"></p>
  <div class="viewer" id="viewer">
    <img src="" id="artwork" alt="">
  </div>
  <div class="popup" id="popup">
    <span class="popup-close" id="popup-close">&times;</span>
    <div class="lens-tabs" id="lens-tabs"></div>
    <div class="poem-title" id="popup-title"></div>
    <div class="poem-poet" id="popup-poet"></div>
    <img class="poem-image" id="popup-image" alt="" style="display:none;">
    <div class="poem-text" id="popup-text"></div>
  </div>
</div>

<!-- Hidden canvas for reading segmentation mask pixels -->
<canvas id="maskCanvas" style="display:none;"></canvas>

<script>
// --- Parse a markdown file with key: value front-matter + body text ---
function parsePoemMarkdown(text) {
  const lines = text.split('\n');
  const meta = {};
  let bodyStart = 0;
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    if (line.trim() === '') {
      bodyStart = i + 1;
      break;
    }
    const colon = line.indexOf(':');
    if (colon > 0) {
      const key = line.substring(0, colon).trim();
      const val = line.substring(colon + 1).trim();
      meta[key] = val;
    }
  }
  meta.text = lines.slice(bodyStart).join('\n').trim();
  return meta;
}

// --- Build a getLabel function from manifest colorRules ---
function buildGetLabel(segments) {
  return function(r, g, b) {
    for (const seg of segments) {
      const rule = seg.colorRule;
      let match = true;
      if (rule.r_gt !== undefined && !(r > rule.r_gt)) match = false;
      if (rule.r_lt !== undefined && !(r < rule.r_lt)) match = false;
      if (rule.g_gt !== undefined && !(g > rule.g_gt)) match = false;
      if (rule.g_lt !== undefined && !(g < rule.g_lt)) match = false;
      if (rule.b_gt !== undefined && !(b > rule.b_gt)) match = false;
      if (rule.b_lt !== undefined && !(b < rule.b_lt)) match = false;
      if (match) return seg.label;
    }
    return null;
  };
}

// --- Highlight keyword in poem text using DOM (safe, no innerHTML) ---
function setHighlightedText(container, text, keyword) {
  container.textContent = '';
  if (!keyword) {
    container.textContent = text;
    return;
  }
  const regex = new RegExp('(' + keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
  const parts = text.split(regex);
  for (const part of parts) {
    if (regex.test(part)) {
      regex.lastIndex = 0;
      const span = document.createElement('span');
      span.style.color = '#e8913a';
      span.style.fontWeight = '600';
      span.textContent = part;
      container.appendChild(span);
    } else {
      container.appendChild(document.createTextNode(part));
    }
  }
}

// --- DOM references ---
const galleryScreen = document.getElementById('gallery-screen');
const viewerScreen = document.getElementById('viewer-screen');
const galleryGrid = document.getElementById('gallery-grid');
const backBtn = document.getElementById('back-btn');
const viewerSubtitle = document.getElementById('viewer-subtitle');
const artworkEl = document.getElementById('artwork');
const popup = document.getElementById('popup');
const lensTabs = document.getElementById('lens-tabs');
const popupTitle = document.getElementById('popup-title');
const popupPoet = document.getElementById('popup-poet');
const popupImage = document.getElementById('popup-image');
const popupText = document.getElementById('popup-text');
const maskCanvas = document.getElementById('maskCanvas');
const maskCtx = maskCanvas.getContext('2d', { willReadFrequently: true });

// --- Active viewer state ---
let activeLensData = null;  // label -> [{lens, title, poet, url, image, keyword, text}, ...]
let activeGetLabel = null;
let activeBasePath = null;
let currentLabel = null;
let currentLensIndex = 0;
let pinned = false;
let pinnedData = null;

// --- Load gallery from manifests ---
async function loadGallery() {
  const galleryResp = await fetch('images/gallery.json');
  const imageIds = await galleryResp.json();

  for (const id of imageIds) {
    const basePath = 'images/' + id;
    const manifestResp = await fetch(basePath + '/manifest.json');
    const manifest = await manifestResp.json();

    const div = document.createElement('div');
    div.className = 'gallery-item';
    const img = document.createElement('img');
    img.src = basePath + '/' + manifest.image;
    img.alt = manifest.title;
    const titleDiv = document.createElement('div');
    titleDiv.className = 'item-title';
    titleDiv.textContent = manifest.title;
    div.appendChild(img);
    div.appendChild(titleDiv);
    if (manifest.gallery && manifest.galleryUrl) {
      const galleryLink = document.createElement('div');
      galleryLink.className = 'item-gallery';
      const a = document.createElement('a');
      a.href = manifest.galleryUrl;
      a.target = '_blank';
      a.rel = 'noopener';
      a.textContent = manifest.gallery;
      a.addEventListener('click', (e) => e.stopPropagation());
      galleryLink.appendChild(a);
      div.appendChild(galleryLink);
    }
    div.addEventListener('click', () => openViewer(manifest, basePath));
    galleryGrid.appendChild(div);
  }
}

// --- Open viewer for a given gallery item ---
async function openViewer(manifest, basePath) {
  activeBasePath = basePath;
  activeGetLabel = buildGetLabel(manifest.segments);
  currentLabel = null;

  artworkEl.src = basePath + '/' + manifest.image;
  artworkEl.alt = manifest.title;
  viewerSubtitle.textContent = 'Hover over regions to explore \u2014 ' + manifest.title;

  // Load mask
  const maskImg = new Image();
  maskImg.onload = function() {
    maskCanvas.width = maskImg.width;
    maskCanvas.height = maskImg.height;
    maskCtx.drawImage(maskImg, 0, 0);
  };
  maskImg.src = basePath + '/' + manifest.mask;

  // Load lens data from markdown files for each segment
  const lensData = {};
  for (const seg of manifest.segments) {
    const lenses = [];
    for (const lens of seg.lenses) {
      const mdPath = basePath + '/' + seg.dir + '/' + lens + '/' + seg.dir + '.md';
      try {
        const resp = await fetch(mdPath);
        if (resp.ok) {
          const text = await resp.text();
          const meta = parsePoemMarkdown(text);
          lenses.push({
            lens: lens,
            title: meta.title,
            poet: meta.poet,
            url: meta.url,
            image: meta.image ? basePath + '/' + seg.dir + '/' + lens + '/' + meta.image : '',
            keyword: meta.keyword,
            text: meta.text
          });
        }
      } catch (e) {
        console.warn('Could not load ' + mdPath, e);
      }
    }
    if (lenses.length > 0) {
      lensData[seg.label] = lenses;
    }
  }
  activeLensData = lensData;

  galleryScreen.classList.add('hidden');
  viewerScreen.classList.remove('hidden');
}

// --- Back to gallery ---
backBtn.addEventListener('click', () => {
  viewerScreen.classList.add('hidden');
  galleryScreen.classList.remove('hidden');
  popup.classList.remove('visible');
  popup.classList.remove('pinned');
  pinned = false;
  pinnedData = null;
  currentLabel = null;
});

// --- Popup positioning ---
function positionPopup(clientX, clientY) {
  const pw = 320;
  const ph = popup.offsetHeight || 400;
  let left = clientX + 20;
  let top = clientY - 20;
  if (left + pw > window.innerWidth - 10) left = clientX - pw - 20;
  if (top + ph > window.innerHeight - 10) top = window.innerHeight - ph - 10;
  if (top < 10) top = 10;
  popup.style.left = left + 'px';
  popup.style.top = top + 'px';
}

// --- Display a specific lens in the popup ---
function showLensContent(data) {
  popupTitle.textContent = data.title || '';
  popupPoet.textContent = data.poet || '';
  if (data.image) {
    popupImage.src = data.image;
    popupImage.alt = data.title || '';
    popupImage.style.display = 'block';
  } else {
    popupImage.style.display = 'none';
  }
  setHighlightedText(popupText, data.text, data.keyword);
}

// --- Build tab bar for a segment's lenses ---
function buildTabs(lenses, activeIndex) {
  lensTabs.textContent = '';
  if (lenses.length <= 1) {
    lensTabs.style.display = 'none';
    return;
  }
  lensTabs.style.display = 'flex';
  lenses.forEach((lensObj, i) => {
    const tab = document.createElement('button');
    tab.className = 'lens-tab' + (i === activeIndex ? ' active' : '');
    tab.textContent = lensObj.lens;
    tab.addEventListener('click', (e) => {
      e.stopPropagation();
      currentLensIndex = i;
      showLensContent(lenses[i]);
      // Update active tab styling
      lensTabs.querySelectorAll('.lens-tab').forEach((t, j) => {
        t.classList.toggle('active', j === i);
      });
      // If pinned, update the hyperlink on the title
      if (pinned && lenses[i].url) {
        popupTitle.textContent = '';
        const link = document.createElement('a');
        link.href = lenses[i].url;
        link.target = '_blank';
        link.rel = 'noopener';
        link.textContent = lenses[i].title;
        popupTitle.appendChild(link);
      }
    });
    lensTabs.appendChild(tab);
  });
}

// --- Hover interaction ---
artworkEl.addEventListener('mousemove', (e) => {
  if (!activeLensData || !activeGetLabel) return;
  if (pinned) return;

  const rect = artworkEl.getBoundingClientRect();
  const relX = (e.clientX - rect.left) / rect.width;
  const relY = (e.clientY - rect.top) / rect.height;
  const maskX = Math.floor(relX * maskCanvas.width);
  const maskY = Math.floor(relY * maskCanvas.height);

  const pixel = maskCtx.getImageData(maskX, maskY, 1, 1).data;
  const label = activeGetLabel(pixel[0], pixel[1], pixel[2]);

  if (label && activeLensData[label] && activeLensData[label].length > 0) {
    if (label !== currentLabel) {
      const lenses = activeLensData[label];
      currentLensIndex = 0;
      buildTabs(lenses, 0);
      showLensContent(lenses[0]);
      currentLabel = label;
    }
    popup.classList.add('visible');
    positionPopup(e.clientX, e.clientY);
  } else {
    popup.classList.remove('visible');
    currentLabel = null;
  }
});

artworkEl.addEventListener('mouseleave', () => {
  if (pinned) return;
  popup.classList.remove('visible');
  currentLabel = null;
});

// --- Click to pin popup ---
artworkEl.addEventListener('click', () => {
  if (pinned || !popup.classList.contains('visible') || !currentLabel) return;
  const lenses = activeLensData[currentLabel];
  if (!lenses || lenses.length === 0) return;
  const data = lenses[currentLensIndex];
  pinned = true;
  pinnedData = data;
  popup.classList.add('pinned');
  if (data.url) {
    popupTitle.textContent = '';
    const link = document.createElement('a');
    link.href = data.url;
    link.target = '_blank';
    link.rel = 'noopener';
    link.textContent = data.title;
    popupTitle.appendChild(link);
  }
});

// --- Close button unpins popup ---
document.getElementById('popup-close').addEventListener('click', () => {
  pinned = false;
  pinnedData = null;
  popup.classList.remove('pinned');
  popup.classList.remove('visible');
  currentLabel = null;
});

// --- Initialize ---
loadGallery();
</script>
</body>
</html>
