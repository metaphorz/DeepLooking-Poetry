<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Deep Looking</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #1a1a2e;
    color: #e0e0e0;
    font-family: 'Georgia', serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    padding: 20px;
  }
  h1 {
    font-size: 1.6rem;
    font-weight: 300;
    letter-spacing: 0.15em;
    margin-bottom: 8px;
    color: #c4a35a;
  }
  .subtitle {
    font-size: 0.9rem;
    color: #888;
    margin-bottom: 20px;
  }
  .viewer {
    position: relative;
    display: inline-block;
    cursor: crosshair;
  }
  .viewer img {
    display: block;
    max-width: 95vw;
    max-height: 80vh;
  }
  .popup {
    position: fixed;
    background: rgba(26, 26, 46, 0.97);
    border: 1px solid #c4a35a;
    border-radius: 10px;
    padding: 16px;
    color: #e0e0e0;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s;
    z-index: 100;
    width: 320px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.6);
  }
  .popup.visible { opacity: 1; }
  .popup.pinned {
    pointer-events: auto;
    overflow-y: auto;
    max-height: 33vh;
    min-width: 280px;
    user-select: none;
    -webkit-user-select: none;
    cursor: grab;
  }
  .popup-resize {
    position: absolute;
    width: 12px;
    height: 12px;
    z-index: 10;
  }
  .popup-resize.nw { top: 0; left: 0; cursor: nw-resize; }
  .popup-resize.ne { top: 0; right: 0; cursor: ne-resize; }
  .popup-resize.sw { bottom: 0; left: 0; cursor: sw-resize; }
  .popup-resize.se { bottom: 0; right: 0; cursor: se-resize; }
  .popup.pinned .lens-tabs {
    cursor: grab;
  }
  .popup.dragging .lens-tabs {
    cursor: grabbing;
  }
  .popup-close {
    position: absolute;
    top: 8px;
    right: 12px;
    font-size: 1.3rem;
    color: #999;
    cursor: pointer;
    display: none;
    line-height: 1;
  }
  .popup-close:hover { color: #fff; }
  .popup-close:focus { outline: none; }
  .popup.pinned .popup-close { display: block; }
  .popup .poem-title a {
    color: #c4a35a;
    text-decoration: none;
  }
  .popup .poem-title a:hover {
    text-decoration: underline;
  }
  .popup .lens-tabs {
    display: flex;
    gap: 0;
    margin-bottom: 10px;
    border-bottom: 1px solid rgba(196,163,90,0.3);
  }
  .popup .lens-tab {
    padding: 5px 12px;
    font-size: 0.75rem;
    font-family: 'Georgia', serif;
    color: #888;
    cursor: pointer;
    border: 1px solid transparent;
    border-bottom: none;
    border-radius: 6px 6px 0 0;
    background: none;
    transition: color 0.2s, background 0.2s;
    text-transform: capitalize;
  }
  .popup .lens-tab:focus { outline: none; }
  .popup .lens-tab:hover {
    color: #c4a35a;
  }
  .popup .lens-tab.active {
    color: #c4a35a;
    background: rgba(196,163,90,0.1);
    border-color: rgba(196,163,90,0.3);
  }
  .popup.pinned .poem-title,
  .popup.pinned .poem-poet,
  .popup.pinned .poem-text,
  .popup.pinned .poem-image,
  .popup.pinned .poem-video {
    cursor: default;
  }
  .popup .poem-title {
    font-size: 1rem;
    font-weight: 600;
    color: #c4a35a;
    margin-bottom: 2px;
  }
  .popup .poem-poet {
    font-size: 0.8rem;
    color: #999;
    margin-bottom: 10px;
    font-style: italic;
  }
  .popup .poem-image, .popup .poem-video {
    width: 100%;
    max-height: 200px;
    object-fit: contain;
    border-radius: 6px;
    margin-bottom: 10px;
  }
  .image-lightbox {
    position: fixed;
    top: 0; left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.85);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 200;
    cursor: none;
  }
  .image-lightbox img {
    max-width: 90vw;
    max-height: 90vh;
    border-radius: 8px;
    box-shadow: 0 0 40px rgba(0,0,0,0.8);
  }
  .popup .poem-text {
    font-size: 0.85rem;
    line-height: 1.5;
    color: #d0d0d0;
    white-space: pre-line;
  }
  /* Gallery styles */
  .gallery {
    max-width: 900px;
    width: 100%;
  }
  .gallery-grid {
    display: grid;
    grid-template-columns: repeat(2, 280px);
    justify-content: center;
    gap: 24px;
    margin-top: 20px;
  }
  .gallery-item {
    cursor: pointer;
    border-radius: 10px;
    overflow: hidden;
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(196,163,90,0.2);
    transition: transform 0.2s, border-color 0.2s;
    width: 280px;
  }
  .gallery-item:hover {
    transform: translateY(-4px);
    border-color: #c4a35a;
  }
  .gallery-item img {
    width: 100%;
    display: block;
  }
  .gallery-item .item-title {
    padding: 12px 12px 4px;
    font-size: 0.95rem;
    color: #c4a35a;
    text-align: center;
    letter-spacing: 0.05em;
  }
  .gallery-item .item-gallery {
    padding: 0 12px 12px;
    font-size: 0.8rem;
    text-align: center;
  }
  .gallery-item .item-gallery a {
    color: #888;
    text-decoration: none;
  }
  .gallery-item .item-gallery a:hover {
    color: #c4a35a;
    text-decoration: underline;
  }
  .back-btn {
    align-self: flex-start;
    background: none;
    border: 1px solid #c4a35a;
    color: #c4a35a;
    padding: 6px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-family: 'Georgia', serif;
    font-size: 0.85rem;
    margin-bottom: 12px;
    transition: background 0.2s;
  }
  .back-btn:hover {
    background: rgba(196,163,90,0.15);
  }
  .hidden { display: none; }
  .image-lens-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 32px;
    height: 24px;
    border-radius: 4px;
    border: 1px solid rgba(196,163,90,0.6);
    background: rgba(26, 26, 46, 0.8);
    color: #c4a35a;
    font-size: 1.2rem;
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 50;
    transition: background 0.2s, border-color 0.2s;
    line-height: 1;
  }
  .image-lens-btn:focus { outline: none; }
  .image-lens-btn:hover {
    background: rgba(196,163,90,0.2);
    border-color: #c4a35a;
  }
  .segment-tooltip {
    position: fixed;
    background: rgba(26, 26, 46, 0.9);
    border: 1px solid rgba(196,163,90,0.5);
    border-radius: 4px;
    padding: 3px 8px;
    color: #c4a35a;
    font-size: 0.75rem;
    pointer-events: none;
    z-index: 90;
    white-space: nowrap;
  }
  h1 a {
    color: #c4a35a;
    text-decoration: none;
    cursor: pointer;
  }
  h1 a:hover {
    text-decoration: underline;
  }
  .about-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: rgba(0, 0, 0, 0.85);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 300;
  }
  .about-box {
    max-width: 600px;
    padding: 32px;
    background: rgba(26, 26, 46, 0.97);
    border: 1px solid #c4a35a;
    border-radius: 10px;
    color: #d0d0d0;
    font-size: 0.95rem;
    line-height: 1.7;
    text-align: center;
    position: relative;
  }
  .about-box h2 {
    color: #c4a35a;
    margin-bottom: 16px;
    font-weight: 300;
    letter-spacing: 0.1em;
  }
  .about-close {
    position: absolute;
    top: 10px; right: 14px;
    color: #999;
    font-size: 1.3rem;
    cursor: pointer;
  }
  .about-close:hover { color: #fff; }
  .about-close:focus { outline: none; }
  .credits {
    margin-top: 16px;
    font-size: 0.75rem;
    color: #555;
  }
</style>
</head>
<body>

<h1><a id="about-link">DEEP LOOKING</a></h1>

<!-- About overlay -->
<div class="about-overlay" id="about-overlay" style="display:none;">
  <div class="about-box">
    <span class="about-close" id="about-close">&times;</span>
    <h2>DEEP LOOKING</h2>
    What do you see when you experience reality? Your experience is captured by an image or perhaps multiple images in a video. Within these artifacts, one can use multiple lenses for greater insight into looking. We define a lens as a category or element of knowledge classification (classes you took in school, or phrases in a Dewey Decimal system or Library of Congress). We call this Deep Looking. As you go about your day, take time to reflect on what you are seeing and ask questions. Many questions and answers to questions are rooted in academic subjects (disciplines).
  </div>
</div>

<!-- Gallery Screen -->
<div id="gallery-screen" class="gallery">
  <p class="subtitle" style="text-align:center">Select an image to explore</p>
  <div class="gallery-grid" id="gallery-grid"></div>
</div>

<!-- Viewer Screen -->
<div id="viewer-screen" class="hidden">
  <button class="back-btn" id="back-btn">&#8592; Back to Gallery</button>
  <p class="subtitle" id="viewer-subtitle"></p>
  <div class="viewer" id="viewer">
    <img src="" id="artwork" alt="">
    <button class="image-lens-btn" id="image-lens-btn">&#9645;</button>
  </div>
</div>

<!-- Image/video lightbox overlay -->
<div class="image-lightbox" id="lightbox" style="display:none;">
  <img id="lightbox-img" src="" alt="">
  <video id="lightbox-video" autoplay loop muted style="display:none; max-width:90vw; max-height:90vh; border-radius:8px; box-shadow:0 0 40px rgba(0,0,0,0.8);"></video>
</div>

<!-- Hidden canvas for reading segmentation mask pixels -->
<canvas id="maskCanvas" style="display:none;"></canvas>

<script>
// --- Parse a markdown file with key: value front-matter + body text ---
function parsePoemMarkdown(text) {
  const lines = text.split('\n');
  const meta = {};
  let bodyStart = 0;
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    if (line.trim() === '') {
      bodyStart = i + 1;
      break;
    }
    const colon = line.indexOf(':');
    if (colon > 0) {
      const key = line.substring(0, colon).trim();
      const val = line.substring(colon + 1).trim();
      meta[key] = val;
    }
  }
  meta.text = lines.slice(bodyStart).join('\n').trim();
  return meta;
}

// --- Build a getLabel function from manifest colorRules ---
function buildGetLabel(segments) {
  return function(r, g, b) {
    for (const seg of segments) {
      const rule = seg.colorRule;
      let match = true;
      if (rule.r_gt !== undefined && !(r > rule.r_gt)) match = false;
      if (rule.r_lt !== undefined && !(r < rule.r_lt)) match = false;
      if (rule.g_gt !== undefined && !(g > rule.g_gt)) match = false;
      if (rule.g_lt !== undefined && !(g < rule.g_lt)) match = false;
      if (rule.b_gt !== undefined && !(b > rule.b_gt)) match = false;
      if (rule.b_lt !== undefined && !(b < rule.b_lt)) match = false;
      if (match) return seg.label;
    }
    return null;
  };
}

// --- Highlight keyword in poem text using DOM (safe, no innerHTML) ---
function setHighlightedText(container, text, keyword) {
  container.textContent = '';
  if (!keyword) {
    container.textContent = text;
    return;
  }
  const regex = new RegExp('(' + keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
  const parts = text.split(regex);
  for (const part of parts) {
    if (regex.test(part)) {
      regex.lastIndex = 0;
      const span = document.createElement('span');
      span.style.color = '#e8913a';
      span.style.fontWeight = '600';
      span.textContent = part;
      container.appendChild(span);
    } else {
      container.appendChild(document.createTextNode(part));
    }
  }
}

// --- DOM references ---
const galleryScreen = document.getElementById('gallery-screen');
const viewerScreen = document.getElementById('viewer-screen');
const galleryGrid = document.getElementById('gallery-grid');
const backBtn = document.getElementById('back-btn');
const viewerSubtitle = document.getElementById('viewer-subtitle');
const artworkEl = document.getElementById('artwork');
const maskCanvas = document.getElementById('maskCanvas');
const maskCtx = maskCanvas.getContext('2d', { willReadFrequently: true });

const imageLensBtn = document.getElementById('image-lens-btn');

// --- Active viewer state ---
let activeLensData = null;  // label -> [{lens, title, poet, url, image, keyword, text}, ...]
let activeImageLensData = null;  // [{lens, title, poet, url, image, video, keyword, text}, ...]
let activeGetLabel = null;
let activeBasePath = null;
let openPopups = [];  // track all open popup elements

// --- Segment/region tooltip ---
const tooltip = document.createElement('div');
tooltip.className = 'segment-tooltip';
tooltip.style.display = 'none';
document.body.appendChild(tooltip);

// --- Load gallery from manifests ---
async function loadGallery() {
  const cacheBust = '?t=' + Date.now();
  const galleryResp = await fetch('images/gallery.json' + cacheBust);
  const imageIds = await galleryResp.json();

  for (const id of imageIds) {
    const basePath = 'images/' + id;
    const manifestResp = await fetch(basePath + '/manifest.json' + cacheBust);
    const manifest = await manifestResp.json();

    const div = document.createElement('div');
    div.className = 'gallery-item';
    const img = document.createElement('img');
    img.src = basePath + '/' + manifest.image;
    img.alt = manifest.title;
    const titleDiv = document.createElement('div');
    titleDiv.className = 'item-title';
    titleDiv.textContent = manifest.title;
    div.appendChild(img);
    div.appendChild(titleDiv);
    if (manifest.gallery && manifest.galleryUrl) {
      const galleryLink = document.createElement('div');
      galleryLink.className = 'item-gallery';
      const a = document.createElement('a');
      a.href = manifest.galleryUrl;
      a.target = '_blank';
      a.rel = 'noopener';
      a.textContent = manifest.gallery;
      a.addEventListener('click', (e) => e.stopPropagation());
      galleryLink.appendChild(a);
      div.appendChild(galleryLink);
    }
    div.addEventListener('click', () => openViewer(manifest, basePath));
    galleryGrid.appendChild(div);
  }
}

// --- Open viewer for a given gallery item ---
async function openViewer(manifest, basePath) {
  activeBasePath = basePath;
  activeGetLabel = buildGetLabel(manifest.segments);

  artworkEl.src = basePath + '/' + manifest.image;
  artworkEl.alt = manifest.title;
  viewerSubtitle.textContent = 'Mouse click in the image to explore \u2014 ' + manifest.title;

  // Load mask
  const maskImg = new Image();
  maskImg.onload = function() {
    maskCanvas.width = maskImg.width;
    maskCanvas.height = maskImg.height;
    maskCtx.drawImage(maskImg, 0, 0);
  };
  maskImg.src = basePath + '/' + manifest.mask;

  // Load lens data from markdown files for each segment
  const lensData = {};
  const cb = '?t=' + Date.now();
  for (const seg of manifest.segments) {
    const lenses = [];
    for (const lens of seg.lenses) {
      const mdPath = basePath + '/' + seg.dir + '/' + lens + '/' + seg.dir + '.md';
      try {
        const resp = await fetch(mdPath + cb);
        if (resp.ok) {
          const text = await resp.text();
          const meta = parsePoemMarkdown(text);
          lenses.push({
            lens: lens,
            title: meta.title,
            poet: meta.poet,
            url: meta.url,
            image: meta.image ? basePath + '/' + seg.dir + '/' + lens + '/' + meta.image : '',
            video: meta.video ? basePath + '/' + seg.dir + '/' + lens + '/' + meta.video : '',
            youtube: meta.youtube || '',
            keyword: meta.keyword,
            text: meta.text
          });
        }
      } catch (e) {
        console.warn('Could not load ' + mdPath, e);
      }
    }
    if (lenses.length > 0) {
      lensData[seg.label] = lenses;
    }
  }
  activeLensData = lensData;

  // Load whole-image lenses (e.g. cinematography) from wholeimage/ directory
  activeImageLensData = [];
  if (manifest.imageLenses && manifest.imageLenses.length > 0) {
    for (const lens of manifest.imageLenses) {
      const lensDir = basePath + '/wholeimage/' + lens;
      const mdPath = lensDir + '/wholeimage.md';
      try {
        const resp = await fetch(mdPath + cb);
        if (resp.ok) {
          const text = await resp.text();
          const meta = parsePoemMarkdown(text);
          activeImageLensData.push({
            lens: lens,
            title: meta.title,
            poet: meta.poet,
            url: meta.url,
            image: meta.image ? lensDir + '/' + meta.image : '',
            video: meta.video ? lensDir + '/' + meta.video : '',
            youtube: meta.youtube || '',
            keyword: meta.keyword,
            text: meta.text
          });
        }
      } catch (e) {
        console.warn('Could not load image lens ' + mdPath, e);
      }
    }
  }
  imageLensBtn.style.display = activeImageLensData.length > 0 ? 'flex' : 'none';

  galleryScreen.classList.add('hidden');
  viewerScreen.classList.remove('hidden');
}

// --- Image lens button click ---
// --- Whole-image button tooltip (instant, matching segment tooltip) ---
imageLensBtn.addEventListener('mouseenter', (e) => {
  const rect = imageLensBtn.getBoundingClientRect();
  tooltip.textContent = 'Whole image';
  tooltip.style.left = (rect.left - 80) + 'px';
  tooltip.style.top = (rect.bottom + 6) + 'px';
  tooltip.style.display = 'block';
});
imageLensBtn.addEventListener('mouseleave', () => {
  tooltip.style.display = 'none';
});

imageLensBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  if (!activeImageLensData || activeImageLensData.length === 0) return;
  const btnRect = imageLensBtn.getBoundingClientRect();
  createPopup(activeImageLensData, btnRect.left - 310, btnRect.bottom + 8);
});

// --- Back to gallery ---
backBtn.addEventListener('click', () => {
  viewerScreen.classList.add('hidden');
  galleryScreen.classList.remove('hidden');
  // Remove all open popups and tooltip
  openPopups.forEach(p => p.remove());
  openPopups = [];
  imageLensBtn.style.display = 'none';
  if (document.querySelector('.segment-tooltip')) document.querySelector('.segment-tooltip').style.display = 'none';
});

// --- Lightbox references ---
const lightbox = document.getElementById('lightbox');
const lightboxImg = document.getElementById('lightbox-img');
const lightboxVideo = document.getElementById('lightbox-video');

// --- Click or ESC to dismiss lightbox ---
lightbox.addEventListener('click', () => {
  lightbox.style.display = 'none';
  lightboxVideo.src = '';
});
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && lightbox.style.display === 'flex') {
    lightbox.style.display = 'none';
    lightboxVideo.src = '';
  }
});

// --- Create a new popup for given lenses at position ---
function createPopup(lenses, posX, posY) {
  const el = document.createElement('div');
  el.className = 'popup visible pinned';
  el.style.position = 'fixed';
  el.style.zIndex = 100 + openPopups.length;

  // Build inner structure using DOM methods
  const closeBtn = document.createElement('span');
  closeBtn.className = 'popup-close';
  closeBtn.style.display = 'block';
  closeBtn.textContent = '\u00D7';
  const tabs = document.createElement('div');
  tabs.className = 'lens-tabs';
  tabs.style.display = 'flex';
  const titleEl = document.createElement('div');
  titleEl.className = 'poem-title';
  const poetEl = document.createElement('div');
  poetEl.className = 'poem-poet';
  const imgEl = document.createElement('img');
  imgEl.className = 'poem-image';
  imgEl.style.display = 'none';
  const vidEl = document.createElement('video');
  vidEl.className = 'poem-video';
  vidEl.controls = true; vidEl.autoplay = true; vidEl.loop = true; vidEl.muted = true;
  vidEl.style.display = 'none';
  const ytEl = document.createElement('iframe');
  ytEl.className = 'poem-video';
  ytEl.style.display = 'none';
  ytEl.style.border = 'none';
  ytEl.style.width = '100%';
  ytEl.style.aspectRatio = '16/9';
  ytEl.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
  ytEl.allowFullscreen = true;
  const textEl = document.createElement('div');
  textEl.className = 'poem-text';

  el.appendChild(closeBtn);
  el.appendChild(tabs);
  el.appendChild(titleEl);
  el.appendChild(poetEl);
  el.appendChild(imgEl);
  el.appendChild(vidEl);
  el.appendChild(ytEl);
  el.appendChild(textEl);

  // Show lens content in this popup
  function showContent(data) {
    titleEl.textContent = '';
    if (data.url) {
      const link = document.createElement('a');
      link.href = data.url; link.target = '_blank'; link.rel = 'noopener';
      link.textContent = data.title || '';
      titleEl.appendChild(link);
    } else {
      titleEl.textContent = data.title || '';
    }
    poetEl.textContent = data.poet || '';
    if (data.youtube) {
      ytEl.src = data.youtube; ytEl.style.display = 'block';
      vidEl.style.display = 'none'; vidEl.src = ''; imgEl.style.display = 'none';
    } else if (data.video) {
      vidEl.src = data.video; vidEl.load(); vidEl.play();
      vidEl.style.display = 'block'; imgEl.style.display = 'none'; ytEl.style.display = 'none'; ytEl.src = '';
    } else if (data.image) {
      imgEl.src = data.image; imgEl.alt = data.title || '';
      imgEl.style.display = 'block'; vidEl.style.display = 'none'; vidEl.src = ''; ytEl.style.display = 'none'; ytEl.src = '';
    } else {
      imgEl.style.display = 'none'; vidEl.style.display = 'none'; vidEl.src = ''; ytEl.style.display = 'none'; ytEl.src = '';
    }
    setHighlightedText(textEl, data.text, data.keyword);
  }

  // Build tabs
  const lensDisplayNames = { cs: 'Comp Sci', language: 'Language', geology: 'Geology', matsci: 'Material Sci', botany: 'Botany', cinematography: 'Cinema', modeling: 'Modeling', art: 'Art', ancienthistory: 'Ancient History', education: 'Education' };
  lenses.forEach((lensObj, i) => {
    const tab = document.createElement('button');
    tab.className = 'lens-tab' + (i === 0 ? ' active' : '');
    tab.textContent = lensDisplayNames[lensObj.lens] || lensObj.lens;
    tab.addEventListener('click', (e) => {
      e.stopPropagation();
      showContent(lenses[i]);
      tabs.querySelectorAll('.lens-tab').forEach((t, j) => t.classList.toggle('active', j === i));
    });
    tabs.appendChild(tab);
  });

  // Show first lens
  showContent(lenses[0]);

  // Position
  const pw = 320;
  let left = posX + 20, top = posY - 20;
  if (left + pw > window.innerWidth - 10) left = posX - pw - 20;
  if (top + 400 > window.innerHeight - 10) top = window.innerHeight - 410;
  if (top < 10) top = 10;
  el.style.left = left + 'px';
  el.style.top = top + 'px';

  // Close button
  closeBtn.addEventListener('click', () => {
    el.remove();
    openPopups = openPopups.filter(p => p !== el);
  });

  // Click image to open lightbox
  imgEl.addEventListener('click', () => {
    if (!imgEl.src || imgEl.style.display === 'none') return;
    lightboxVideo.style.display = 'none'; lightboxVideo.src = '';
    lightboxImg.src = imgEl.src; lightboxImg.alt = imgEl.alt;
    lightboxImg.style.display = 'block';
    lightbox.style.display = 'flex';
  });

  // Click video to open lightbox
  vidEl.addEventListener('click', () => {
    if (!vidEl.src || vidEl.style.display === 'none') return;
    lightboxImg.style.display = 'none';
    lightboxVideo.src = vidEl.src;
    lightboxVideo.currentTime = vidEl.currentTime;
    lightboxVideo.style.display = 'block'; lightboxVideo.play();
    lightbox.style.display = 'flex';
  });

  // Draggable from tab bar or any edge/padding area of the popup
  let dragging = false, dragOffX = 0, dragOffY = 0;
  function startDrag(e) {
    dragging = true;
    dragOffX = e.clientX - el.getBoundingClientRect().left;
    dragOffY = e.clientY - el.getBoundingClientRect().top;
    el.classList.add('dragging');
    e.preventDefault();
  }
  tabs.addEventListener('mousedown', (e) => {
    if (e.target.classList.contains('lens-tab')) return;
    startDrag(e);
  });
  el.addEventListener('mousedown', (e) => {
    // Drag when clicking directly on the popup (padding/border), not on child content
    if (e.target === el) startDrag(e);
  });
  document.addEventListener('mousemove', (e) => {
    if (!dragging) return;
    el.style.left = (e.clientX - dragOffX) + 'px';
    el.style.top = (e.clientY - dragOffY) + 'px';
  });
  document.addEventListener('mouseup', () => {
    if (dragging) { dragging = false; el.classList.remove('dragging'); }
  });

  // Resize handles on all four corners
  ['nw','ne','sw','se'].forEach(corner => {
    const handle = document.createElement('div');
    handle.className = 'popup-resize ' + corner;
    el.appendChild(handle);
    let resizing = false, startX, startY, startW, startH, startL, startT;
    handle.addEventListener('mousedown', (e) => {
      e.preventDefault(); e.stopPropagation();
      resizing = true;
      startX = e.clientX; startY = e.clientY;
      const rect = el.getBoundingClientRect();
      startW = rect.width; startH = rect.height;
      startL = rect.left; startT = rect.top;
      const onMove = (ev) => {
        if (!resizing) return;
        const dx = ev.clientX - startX, dy = ev.clientY - startY;
        if (corner.includes('e')) el.style.width = Math.max(280, startW + dx) + 'px';
        if (corner.includes('w')) { el.style.width = Math.max(280, startW - dx) + 'px'; el.style.left = (startL + dx) + 'px'; }
        if (corner.includes('s')) el.style.height = (startH + dy) + 'px';
        if (corner.includes('n')) { el.style.height = (startH - dy) + 'px'; el.style.top = (startT + dy) + 'px'; }
      };
      const onUp = () => { resizing = false; document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); };
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onUp);
    });
  });

  viewerScreen.appendChild(el);
  openPopups.push(el);
  return el;
}

// --- Hover tooltip showing segment name ---
artworkEl.addEventListener('mousemove', (e) => {
  if (!activeLensData || !activeGetLabel) return;
  const rect = artworkEl.getBoundingClientRect();
  const relX = (e.clientX - rect.left) / rect.width;
  const relY = (e.clientY - rect.top) / rect.height;
  const maskX = Math.floor(relX * maskCanvas.width);
  const maskY = Math.floor(relY * maskCanvas.height);
  const pixel = maskCtx.getImageData(maskX, maskY, 1, 1).data;
  const label = activeGetLabel(pixel[0], pixel[1], pixel[2]);
  if (label && activeLensData[label]) {
    tooltip.textContent = label;
    tooltip.style.left = (e.clientX + 14) + 'px';
    tooltip.style.top = (e.clientY + 14) + 'px';
    tooltip.style.display = 'block';
  } else {
    tooltip.style.display = 'none';
  }
});

artworkEl.addEventListener('mouseleave', () => {
  tooltip.style.display = 'none';
});

// --- Click on artwork to open popup ---
artworkEl.addEventListener('click', (e) => {
  if (!activeLensData || !activeGetLabel) return;
  const rect = artworkEl.getBoundingClientRect();
  const relX = (e.clientX - rect.left) / rect.width;
  const relY = (e.clientY - rect.top) / rect.height;
  const maskX = Math.floor(relX * maskCanvas.width);
  const maskY = Math.floor(relY * maskCanvas.height);
  const pixel = maskCtx.getImageData(maskX, maskY, 1, 1).data;
  const label = activeGetLabel(pixel[0], pixel[1], pixel[2]);
  if (label && activeLensData[label] && activeLensData[label].length > 0) {
    createPopup(activeLensData[label], e.clientX, e.clientY);
  }
});

// --- About overlay ---
const aboutOverlay = document.getElementById('about-overlay');
document.getElementById('about-link').addEventListener('click', () => {
  aboutOverlay.style.display = 'flex';
});
document.getElementById('about-close').addEventListener('click', () => {
  aboutOverlay.style.display = 'none';
});
aboutOverlay.addEventListener('click', (e) => {
  if (e.target === aboutOverlay) aboutOverlay.style.display = 'none';
});

// --- Initialize ---
loadGallery();
</script>
</body>
</html>
